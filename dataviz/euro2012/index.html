<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Euro 2012</title>
    <meta name="description"
          content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">

    <link rel="canonical" href="{{ page.url | replace:'index.html','' | prepend: site.baseurl | prepend: site.url }}">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <link href='https://fonts.googleapis.com/css?family=Crimson+Text|Lato' rel='stylesheet' type='text/css'>
    <link href='style.css' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="artwork">
    <div id="chart"></div>
    <div id="heading">
        <h1>EURO 2012 Knockout phase matches</h1>
        <p class="ref">
            Source:
            <a href="http://www.uefa.com/multimediafiles/download/competitions/euro/91/87/57/918757_download.pdf">
                Regulations of the UEFA European Football Championship
            </a>
        </p>
        <p class="legend">
            A, B, C, D is the name of a group.
        </p>
        <p class="legend">
            "W" stands for group winner, "R" for group runners-up of each group.
        </p>
    </div>
</div>
<script>
    var DIMENSIONS = {
        radius: 190,
        minTeamThickness: 30,
        eachTeamThickness: 20,
        groupThickness: 0,
        groupPadAngle: 0.1,
        chordPadAngle: 0.01,
        chordPadAngleEdge: 0.02,
        width: 580,
        height: 460,
        margin: {
            top: 40, right: 10, bottom: 10, left: 100
        }
    };

    var EURO_GROUPS = [
        {group: 'A', teams: ['WA', 'RA']},
        {group: 'B', teams: ['WB', 'RB']},
        {group: 'C', teams: ['WC', 'RC']},
        {group: 'D', teams: ['WD', 'RD']}
    ];

    var groupColorScale = d3.scale.category10();

    var svg = d3.select('#chart')
            .append('svg')
            .attr('class', 'circle')
            .attr('width', DIMENSIONS.width)
            .attr('height', DIMENSIONS.height);

    var g = svg.append('g')
            .attr('class', 'group-teams')
            .attr('width', DIMENSIONS.width - DIMENSIONS.margin.left - DIMENSIONS.margin.right)
            .attr('width', DIMENSIONS.height - DIMENSIONS.margin.top - DIMENSIONS.margin.bottom)
            .attr('transform', "translate(" + (DIMENSIONS.margin.left + DIMENSIONS.radius) + "," + (DIMENSIONS.margin.top + DIMENSIONS.radius) + ")");

    var arc = d3.svg.arc();
    var chord = d3.svg.chord()
            .radius(DIMENSIONS.radius - DIMENSIONS.groupThickness);

    function drawChord() {
        var groupsData = layoutTeams(EURO_GROUPS);
        var matchesData = layoutMatches(groupsData);
        var teams = g.selectAll('path.group-teams')
                .data(groupsData);

        teams.enter()
                .append('path')
                .attr('class', 'group-teams')
                .attr('d', arc)
                .attr('fill', function (d) {
                    return d.color;
                })
                .style('fill-opacity', function (d) {
                    return d.fillOpacity;
                })
                .on('mouseenter', function (d) {
                    d3.selectAll('path.match')
                            .filter(function (m) {
                                return m.source.teamCode !== d.label && m.target.teamCode !== d.label;
                            })
                            .transition()
                            .attr('fill-opacity', 0.1);
                })
                .on('mouseout', function (d) {
                    d3.selectAll('path.match')
                            .transition()
                            .attr('fill-opacity', chordOpacity);
                });

        teams.transition()
                .style('fill-opacity', function (d) {
                    return d.fillOpacity;
                });

        var teamCodes = g.selectAll('text.team-code')
                .data(groupsData);

        teamCodes.enter()
                .append('text')
                .attr('class', 'team-code')
                .text(function (d) {
                    return d.label
                })
                .attr('pointer-events', 'none')
                .attr('transform', function (d) {
                    var angle = (d.startAngle + d.endAngle) / 2;
                    var r = DIMENSIONS.radius + DIMENSIONS.minTeamThickness / 2
                    var y = Math.cos(angle) * r;
                    var x = Math.sin(angle) * r;

                    return "translate(" + x + "," + -y + ")";
                })
                .attr('text-anchor', 'middle')
                .attr('dy', 6);

        var matches = g.selectAll('path.match')
                .data(matchesData, function(d){
                    return d.source.teamCode + "-" + d.target.teamCode;
                });

        matches.enter()
                .append('path')
                .attr('class', 'match')
                .attr('d', chord)
                .attr('fill', '#bbb')
                .attr('fill-opacity', chordOpacity);

        matches.transition()
                .attr('d', chord)
                .attr('fill-opacity', chordOpacity);

        matches.exit()
                .transition()
                .remove();
    }

    function chordOpacity(d) {
        return 0.8;
    }

    function layoutTeams(groups) {
        var results = [];

        var teamAngle = (Math.PI / 2 - DIMENSIONS.groupPadAngle) / 2;
        groups.forEach(function (g, i) {
            var groupStartAngle = Math.PI / 2 * i;
            g.teams.forEach(function (t, j) {
                results.push({
                    innerRadius: DIMENSIONS.radius,
                    outerRadius: DIMENSIONS.radius + DIMENSIONS.minTeamThickness,
                    startAngle: groupStartAngle + j * teamAngle,
                    endAngle: groupStartAngle + (j + 1) * teamAngle,
                    color: groupColorScale(i),
                    fillOpacity: (1 - j * 0.15),
                    label: t
                });
            })
        });

        return results;
    }

    function layoutMatches(groups) {
        var teams = new Array(8).fill(0);
        var teamCurrentMatchNumber = new Array(8).fill(0);
        var matches = [];

        // Add matches
        // http://www.uefa.com/MultimediaFiles/Download/Regulations/uefaorg/Regulations/02/03/92/81/2039281_DOWNLOAD.pdf
        // Section 17.03
        matches.push(addMatch("WA", "RB", teams));
        matches.push(addMatch("WB", "RA", teams));
        matches.push(addMatch("WC", "RD", teams));
        matches.push(addMatch("WD", "RC", teams));

        // Calculate start and end angle
        matches.forEach(function (m) {
            var source = groups[m.source.teamIndex];
            var target = groups[m.target.teamIndex];
            var sourceAngle = (source.endAngle - source.startAngle - 2 * DIMENSIONS.chordPadAngleEdge) / teams[m.source.teamIndex];
            var targetAngle = (target.endAngle - target.startAngle - 2 * DIMENSIONS.chordPadAngleEdge) / teams[m.target.teamIndex];

            m.source.startAngle = source.startAngle + DIMENSIONS.chordPadAngleEdge + sourceAngle * teamCurrentMatchNumber[m.source.teamIndex] + DIMENSIONS.chordPadAngle;
            m.source.endAngle = source.startAngle + DIMENSIONS.chordPadAngleEdge + sourceAngle * (teamCurrentMatchNumber[m.source.teamIndex] + 1) - DIMENSIONS.chordPadAngle;
            m.source.isCertain = teams[m.source.teamIndex] === 1;
            teamCurrentMatchNumber[m.source.teamIndex]++;

            m.target.startAngle = target.startAngle + DIMENSIONS.chordPadAngleEdge + targetAngle * teamCurrentMatchNumber[m.target.teamIndex] + DIMENSIONS.chordPadAngle;
            m.target.endAngle = target.startAngle + DIMENSIONS.chordPadAngleEdge + targetAngle * (teamCurrentMatchNumber[m.target.teamIndex] + 1) - DIMENSIONS.chordPadAngle;
            m.target.isCertain = teams[m.target.teamIndex] === 1;
            teamCurrentMatchNumber[m.target.teamIndex]++;

        })

        return matches;
    }

    function addMatch(team1, team2, teams) {
        var t1 = getTeamIndex(team1);
        var t2 = getTeamIndex(team2);

        teams[t1]++;
        teams[t2]++;

        return {
            source: {
                teamIndex: t1,
                teamCode: team1
            },
            target: {
                teamIndex: t2,
                teamCode: team2
            }
        }
    }

    function getTeamIndex(teamCode) {
        var groupCode = teamCode.charCodeAt(1) - 65;
        var teamStandingCode = teamCode.charAt(0);
        var teamIndex = teamStandingCode === "W" ? 0 : 1;

        return 2 * groupCode + teamIndex
    }

    drawChord();
</script>
</body>
</html>