<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Euro 2016</title>
    <meta name="description"
          content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">

    <link rel="canonical" href="{{ page.url | replace:'index.html','' | prepend: site.baseurl | prepend: site.url }}">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <link href='https://fonts.googleapis.com/css?family=Crimson+Text|Lato' rel='stylesheet' type='text/css'>
    <link href='style.css' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="artwork">
    <div id="chart"></div>
</div>
<script>
    var DIMENSIONS = {
        radius: 200,
        minTeamThickness: 40,
        eachTeamThickness: 20,
        groupThickness: 10,
        groupPadAngle: 0.1,
        chordPadAngle: 0.01,
        chordPadAngleEdge: 0.02,
        width: 600,
        height: 600,
        margin: {
            top: 100, right: 10, bottom: 10, left: 100
        }
    };

    var EURO_GROUPS = [
        {group: 'A', teams: [0, 0, 0]},
        {group: 'B', teams: [0, 0, 0]},
        {group: 'C', teams: [0, 0, 0]},
        {group: 'D', teams: [0, 0, 0]},
        {group: 'E', teams: [0, 0, 0]},
        {group: 'F', teams: [0, 0, 0]},
    ];

    var EURO_3RD = [
        {qualifiedTeams: d3.set(["A", "B", "C", "D"]), opponents: ["C", "D", "A", "B"]},
        {qualifiedTeams: d3.set(["A", "B", "C", "E"]), opponents: ["C", "A", "B", "E"]},
        {qualifiedTeams: d3.set(["A", "B", "C", "F"]), opponents: ["C", "A", "B", "F"]},
        {qualifiedTeams: d3.set(["A", "B", "D", "E"]), opponents: ["D", "A", "B", "E"]},
        {qualifiedTeams: d3.set(["A", "B", "D", "F"]), opponents: ["D", "A", "B", "F"]},
        {qualifiedTeams: d3.set(["A", "B", "E", "F"]), opponents: ["E", "A", "B", "F"]},
        {qualifiedTeams: d3.set(["A", "C", "D", "E"]), opponents: ["C", "D", "A", "E"]},
        {qualifiedTeams: d3.set(["A", "C", "D", "F"]), opponents: ["C", "D", "A", "F"]},
        {qualifiedTeams: d3.set(["A", "C", "E", "F"]), opponents: ["C", "A", "F", "E"]},
        {qualifiedTeams: d3.set(["A", "D", "E", "F"]), opponents: ["D", "A", "F", "E"]},
        {qualifiedTeams: d3.set(["B", "C", "D", "E"]), opponents: ["C", "D", "B", "E"]},
        {qualifiedTeams: d3.set(["B", "C", "D", "F"]), opponents: ["C", "D", "B", "F"]},
        {qualifiedTeams: d3.set(["B", "C", "E", "F"]), opponents: ["E", "C", "B", "F"]},
        {qualifiedTeams: d3.set(["B", "D", "E", "F"]), opponents: ["E", "D", "B", "F"]},
        {qualifiedTeams: d3.set(["C", "D", "E", "F"]), opponents: ["C", "D", "F", "E"]}
    ];

    var chosen3rdGroupTeams = d3.set([]);
    var groupColorScale = d3.scale.category10();

    var svg = d3.select('#chart')
            .append('svg')
            .attr('class', 'circle')
            .attr('width', DIMENSIONS.width)
            .attr('height', DIMENSIONS.height);

    var g = svg.append('g')
            .attr('class', 'group-teams')
            .attr('width', DIMENSIONS.width - DIMENSIONS.margin.left - DIMENSIONS.margin.right)
            .attr('width', DIMENSIONS.height - DIMENSIONS.margin.top - DIMENSIONS.margin.bottom)
            .attr('transform', "translate(" + (DIMENSIONS.margin.left + DIMENSIONS.radius) + "," + (DIMENSIONS.margin.top + DIMENSIONS.radius) + ")");

    var div = d3.select('#chart')
            .append('div')
            .attr('class', 'group-buttons');

    div.append('h4')
            .text('Choose 4 of 6 third-placed teams to advance to knockout phase')

    var arc = d3.svg.arc();
    var chord = d3.svg.chord()
            .radius(DIMENSIONS.radius - DIMENSIONS.groupThickness);

    function drawChord() {
        var groupsData = layoutTeams(EURO_GROUPS);
        var matchesData = layoutMatches(groupsData);
        var teams = g.selectAll('path.group-teams')
                .data(groupsData);

        teams.enter()
                .append('path')
                .attr('class', 'group-teams')
                .attr('d', arc)
                .attr('fill', function (d) {
                    return d.color;
                })
                .style('fill-opacity', function (d) {
                    return d.fillOpacity;
                });

        teams.transition()
                .style('fill-opacity', function (d) {
                    return d.fillOpacity;
                });

        var teamCodes = g.selectAll('text.team-code')
                .data(groupsData);

        teamCodes.enter()
                .append('text')
                .attr('class', 'team-code')
                .text(function (d) {
                    return d.label
                })
                .attr('transform', function (d) {
                    var angle = (d.startAngle + d.endAngle) / 2;
                    var r = DIMENSIONS.radius + DIMENSIONS.minTeamThickness / 2
                    var y = Math.cos(angle) * r;
                    var x = Math.sin(angle) * r;

                    return "translate(" + x + "," + -y + ")";
                })
                .attr('text-anchor', 'middle')
                .attr('dy', 6);

        var matches = g.selectAll('path.match')
                .data(matchesData);

        var colors = d3.scale.category20();

        matches.enter()
                .append('path')
                .attr('class', 'match')
                .attr('d', chord)
                .attr('fill', '#bbb')
                .attr('fill-opacity', function (d) {
                    return (d.source.isCertain && d.target.isCertain) ? 0.8 : 0.4;
                });

        matches.transition()
                .attr('d', chord)
                .attr('fill-opacity', function (d) {
                    return (d.source.isCertain && d.target.isCertain) ? 0.8 : 0.4;
                });

        matches.exit()
                .transition()
                .remove();
    }


    function layoutTeams(groups) {
        var results = [];

        var teamAngle = (Math.PI / 3 - DIMENSIONS.groupPadAngle) / 3;
        groups.forEach(function (g, i) {
            var groupStartAngle = Math.PI / 3 * i;
            g.teams.forEach(function (t, j) {
                results.push({
                    innerRadius: DIMENSIONS.radius,
                    outerRadius: DIMENSIONS.radius + DIMENSIONS.minTeamThickness,
                    startAngle: groupStartAngle + j * teamAngle,
                    endAngle: groupStartAngle + (j + 1) * teamAngle,
                    color: groupColorScale(i),
                    fillOpacity: (j < 2) ? (1 - j * 0.15) : (chosen3rdGroupTeams.has(g.group) ? (1 - j * 0.15) : (chosen3rdGroupTeams.size() < 4) ? 0.4 : 0.1), // the third-placed team
                    label: (j == 0 ? "W" : (j == 1 ? "R" : "3")) + String.fromCharCode(65 + i)
                });
            })
        });

        return results;
    }

    function layoutMatches(groups) {
        var teams = new Array(18).fill(0);
        var teamCurrentMatchNumber = new Array(18).fill(0);
        var matches = [];

        // Add matches
        // http://www.uefa.com/MultimediaFiles/Download/Regulations/uefaorg/Regulations/02/03/92/81/2039281_DOWNLOAD.pdf
        // Section 17.03
        matches.push(addMatch("RA", "RC", teams));
        getPossibleOpponent("D", chosen3rdGroupTeams.values()).forEach(function (t) {
            matches.push(addMatch("WD", "3" + t, teams));
        });
        getPossibleOpponent("B", chosen3rdGroupTeams.values()).forEach(function (t) {
            matches.push(addMatch("WB", "3" + t, teams));
        });
        matches.push(addMatch("WF", "RE", teams));
        getPossibleOpponent("C", chosen3rdGroupTeams.values()).forEach(function (t) {
            matches.push(addMatch("WC", "3" + t, teams));
        });
        matches.push(addMatch("WE", "RD", teams));
        getPossibleOpponent("A", chosen3rdGroupTeams.values()).forEach(function (t) {
            matches.push(addMatch("WA", "3" + t, teams));
        });
        matches.push(addMatch("RB", "RF", teams));

        // Calculate start and end angle
        matches.forEach(function (m) {
            var source = groups[m.source.teamIndex];
            var target = groups[m.target.teamIndex];
            var sourceAngle = (source.endAngle - source.startAngle - 2 * DIMENSIONS.chordPadAngleEdge) / teams[m.source.teamIndex];
            var targetAngle = (target.endAngle - target.startAngle - 2 * DIMENSIONS.chordPadAngleEdge) / teams[m.target.teamIndex];

            m.source.startAngle = source.startAngle + DIMENSIONS.chordPadAngleEdge + sourceAngle * teamCurrentMatchNumber[m.source.teamIndex] + DIMENSIONS.chordPadAngle;
            m.source.endAngle = source.startAngle + DIMENSIONS.chordPadAngleEdge + sourceAngle * (teamCurrentMatchNumber[m.source.teamIndex] + 1) - DIMENSIONS.chordPadAngle;
            m.source.isCertain = teams[m.source.teamIndex] === 1;
            teamCurrentMatchNumber[m.source.teamIndex]++;

            m.target.startAngle = target.startAngle + DIMENSIONS.chordPadAngleEdge + targetAngle * teamCurrentMatchNumber[m.target.teamIndex] + DIMENSIONS.chordPadAngle;
            m.target.endAngle = target.startAngle + DIMENSIONS.chordPadAngleEdge + targetAngle * (teamCurrentMatchNumber[m.target.teamIndex] + 1) - DIMENSIONS.chordPadAngle;
            m.target.isCertain = teams[m.target.teamIndex] === 1;
            teamCurrentMatchNumber[m.target.teamIndex]++;

        })

        return matches;
    }

    function addMatch(team1, team2, teams) {
        var t1 = getTeamIndex(team1);
        var t2 = getTeamIndex(team2);

        teams[t1]++;
        teams[t2]++;

        return {
            source: {
                teamIndex: t1
            },
            target: {
                teamIndex: t2,
            }
        }
    }

    function getTeamIndex(teamCode) {
        var groupCode = teamCode.charCodeAt(1) - 65;
        var teamStandingCode = teamCode.charAt(0);
        var teamIndex = teamStandingCode === "W" ? 0 : (teamStandingCode === "R" ? 1 : 2);

        return 3 * groupCode + teamIndex
    }


    function getPossibleOpponent(winnerGroup, chosen3rdGroups) {
        var posibleMatches = EURO_3RD.filter(function (r) {
            return chosen3rdGroups.map(function (g) {
                return r.qualifiedTeams.has(g);
            }).reduce(function (a, b) {
                return a && b;
            }, true)
        }).map(function (r) {
            return r.opponents[winnerGroup.charCodeAt(0) - 65];
        });

        return d3.set(posibleMatches).values();
    }

    function drawButtons() {

        var buttons = div.selectAll('a.group-button')
                .data(EURO_GROUPS);

        buttons.enter()
                .append('a')
                .attr('class', 'group-button')
                .on('click', function (d) {
                    var group = d.group;
                    if (chosen3rdGroupTeams.has(group)) {
                        chosen3rdGroupTeams.remove(group);
                    } else {
                        if (chosen3rdGroupTeams.size() < 4) {
                            chosen3rdGroupTeams.add(group);
                        }
                    }

                    drawChord();
                    drawButtons();
                })
                .selectAll('span')
                .data(function (d, i) {
                    return [{
                        color: groupColorScale(i),
                        group: d.group,
                    }];
                })
                .enter()
                .append('span')
                .style('background', function (d) {
                    return d.color;
                })
                .text(function (d) {
                    return "Group " + d.group + " third-placed team"
                });

        buttons.style('border-color', function (d, i) {
            var group = d.group;
            if (chosen3rdGroupTeams.has(group)) {
                return groupColorScale(i);
            } else {
                return "transparent";
            }
        }).style('opacity', function (d) {
            var group = d.group;
            if (chosen3rdGroupTeams.size() >= 4 && !chosen3rdGroupTeams.has(group)) {
                return 0.5;
            } else {
                return 1;
            }
        })
    }

    drawChord();
    drawButtons();
</script>
</body>
</html>